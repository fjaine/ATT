#' Producing a quick abacus plot.
#'
#' @param ATTdata input 'ATT' object containing tag detection, metadata and station information.
#' @param theme
#' @param xlab x axis label
#' @param ylab y axis label
#' @param det.col color of points indicating detections (default = "red")
#' @param tag.col color of points indicating start and end of tag life (default = "grey")
#' @param facet conditional argument to plot faceted plot, plotting detections by each animal on receiver stations (default = FALSE)
#' @param new.window conditional argument for plotting in a new window (default = TRUE)
#' @param ... other arguments sent to geom_points to modify plotting aesthetics
#'
#' @return Produces an abacus plot in a new window. Daily detections over time for each tag
#'   (determined by "Tag.ID" field name). If facet parameter is TRUE detections of each tag on
#'   receiver stations plotted.
#' @seealso Input data needs to be setup using \code{\link{setupData}}
#' @export
#' @import dplyr
#' @import ggplot2
#' @examples
#' ## Import example datasets
#' data(tagdata)
#' data(taginfo)
#' data(statinfo)
#'
#' ## Setup data
#' ATTdata<- setupData(Tag.Detections = tagdata, Tag.Metadata = taginfo, Station.Information = statinfo)
#'
#' ## Create abacus plot
#' abacusPlot(ATTdata)
#'
#'
abacusPlot<-function(ATTdata, theme="theme_linedraw", xlab="Date", ylab="Tag ID", det.col=2, tag.col=8, facet=FALSE, new.window=TRUE, ...){
  if(!inherits(ATTdata, "ATT"))
    stop("Oops! Input data needs to be an 'ATT' object.
         \nSet up your data first using setupData() before running this operation")

  ## Combine Tag.Detection and Tag.Metadata into a combined tibble for plotting
  combdata<- left_join(ATTdata$Tag.Detections, ATTdata$Tag.Metadata, by="Tag.ID")

  ## Find start and end date of taglife
  ss<-combdata %>%
    group_by(Tag.ID) %>%
    summarize(Start = min(first(Release.Date), min(date(Date.Time)), na.rm=T),
              End = max((first(Release.Date)+first(Tag.Life)), max(date(Date.Time)), na.rm=T))

  if(new.window){dev.new(noRStudioGD=TRUE, width=9, height=6)}

  if(facet){
    ggplot(combdata) +
      xlab(xlab) + ylab(ylab) +
      geom_point(aes(x = date(Date.Time), y = as.factor(Station.Name)), col=det.col, ...) +
      facet_wrap(~Tag.ID) +
      scale_x_date(date_labels= "%b\n%Y", minor_breaks = NULL) +
      eval(call(theme))
  }else{
    ggplot(combdata) +
      xlab(xlab) + ylab(ylab) +
      geom_point(aes(x = date(Date.Time), y = as.factor(Tag.ID)), col=det.col, ...) +
      geom_point(data= ss, aes(x = Start, y = as.factor(Tag.ID)), pch="|", col=tag.col, cex=3) +
      geom_point(data= ss, aes(x = End, y = as.factor(Tag.ID)), pch="|", col=tag.col, cex=3) +
      scale_x_date(date_labels= "%b\n%Y", minor_breaks = NULL) +
      eval(call(theme))
  }
}
